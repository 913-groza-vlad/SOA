version: '3.9'

networks:
  mednet:

volumes:
  postgres-data:
  kafka-data:
  redis-data:
  rabbitmq-data:

services:
  # --- Datastore ---
  postgres:
    image: postgres:18.1-alpine3.22
    restart: always
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
      POSTGRES_DB: medapp
    ports:
      - '5432:5432'
    healthcheck:
      test: ['CMD-SHELL', 'pg_isready -U postgres -d medapp']
      interval: 10s
      timeout: 5s
      retries: 10
    volumes:
      - postgres-data:/var/lib/postgresql/data
    networks: [mednet]

  # --- Kafka ---
  zookeeper:
    image: confluentinc/cp-zookeeper:7.6.1
    environment:
      ZOOKEEPER_CLIENT_PORT: 2181
    ports:
      - '22181:2181'
    networks: [mednet]

  kafka:
    image: confluentinc/cp-kafka:7.6.1
    depends_on:
      - zookeeper
    ports:
      - '29092:29092'
      - '9092:9092'
    environment:
      KAFKA_ZOOKEEPER_CONNECT: zookeeper:2181
      KAFKA_ZOOKEEPER_SESSION_TIMEOUT_MS: 30000
      KAFKA_ZOOKEEPER_CONNECTION_TIMEOUT_MS: 30000
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://kafka:9092,PLAINTEXT_HOST://localhost:29092
      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: PLAINTEXT:PLAINTEXT,PLAINTEXT_HOST:PLAINTEXT
      KAFKA_INTER_BROKER_LISTENER_NAME: PLAINTEXT
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1
      KAFKA_LOG4J_LOGGERS: 'kafka.controller=INFO,kafka.request.logger=WARN'
      KAFKA_LOG4J_ROOT_LOGLEVEL: WARN
      KAFKA_CREATE_TOPICS: 'log-message:1:1'
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    hostname: kafka
    restart: unless-stopped
    healthcheck:
      test: ['CMD-SHELL', 'nc -z localhost 9092 || exit 1']
      interval: 10s
      timeout: 5s
      retries: 5
    networks: [mednet]

  kafka-init:
    image: confluentinc/cp-kafka:7.6.1
    depends_on:
      kafka:
        condition: service_started
    entrypoint: ['/bin/sh', '-c']
    command: >
      "
      echo 'Waiting for Kafka...';
      for i in `seq 1 30`; do
        nc -z kafka 9092 && break;
        sleep 2;
      done;
      echo 'Creating topics...';
      kafka-topics --bootstrap-server kafka:9092 --create --if-not-exists --topic appointment-events --partitions 1 --replication-factor 1;
      kafka-topics --bootstrap-server kafka:9092 --create --if-not-exists --topic notification-events --partitions 1 --replication-factor 1;
      kafka-topics --bootstrap-server kafka:9092 --create --if-not-exists --topic analytics-events --partitions 1 --replication-factor 1;
      echo 'Topics ready.'
      "
    networks: [mednet]

  # --- RabbitMQ for async commands & notifications fanout ---
  rabbitmq:
    image: rabbitmq:3-management
    restart: unless-stopped
    environment:
      RABBITMQ_DEFAULT_USER: guest
      RABBITMQ_DEFAULT_PASS: guest
    ports:
      - '5672:5672'
      - '15672:15672' # mgmt UI
    volumes:
      - rabbitmq-data:/var/lib/rabbitmq
    healthcheck:
      test: ['CMD', 'rabbitmq-diagnostics', '-q', 'ping']
      interval: 10s
      timeout: 5s
      retries: 10
    networks: [mednet]

  # --- Redis for caching + WS pub/sub scaling ---
  redis:
    image: redis:8.4-alpine
    restart: unless-stopped
    command: ['redis-server', '--save', '', '--appendonly', 'no']
    ports:
      - '6379:6379'
    healthcheck:
      test: ['CMD', 'redis-cli', 'ping']
      interval: 5s
      timeout: 3s
      retries: 20
    networks: [mednet]

  # --- LocalStack (FaaS via AWS Lambda locally) ---
  localstack:
    image: localstack/localstack:latest
    restart: unless-stopped
    environment:
      SERVICES: lambda,s3,sqs,sns,logs,sts,iam
      AWS_DEFAULT_REGION: eu-central-1
      DEBUG: '1'
    ports:
      - '4566:4566' # edge port
    networks: [mednet]

  # --- Dev mail server (SMTP sink) for emails from notification-service ---
  mailhog:
    image: mailhog/mailhog:latest
    restart: unless-stopped
    ports:
      - '1025:1025' # SMTP
      - '8025:8025' # Web UI
    networks: [mednet]

  # ====================== BACKEND SERVICES (Spring Boot) ======================

  api-gateway:
    build:
      context: ./services/api-gateway
      dockerfile: Dockerfile
    restart: unless-stopped
    environment:
      SERVER_PORT: 8080
      SPRING_PROFILES_ACTIVE: docker
      # Auth/JWT
      AUTH_ISSUER_URI: http://auth-service:9000
      AUTH_JWKS_URI: http://auth-service:9000/.well-known/jwks.json
      # Upstreams (service discovery via DNS of service names)
      APPOINTMENT_SERVICE_URL: http://appointment-service:8083
      PATIENT_SERVICE_URL: http://patient-service:8081
      DOCTOR_SERVICE_URL: http://doctor-service:8082
      NOTIFICATION_SERVICE_URL: ws://notification-service:8085
    ports:
      - '8080:8080'
    depends_on:
      postgres:
        condition: service_healthy
      auth-service:
        condition: service_started
    networks: [mednet]

  auth-service:
    build:
      context: ./services/auth-service
      dockerfile: Dockerfile
    restart: unless-stopped
    environment:
      SERVER_PORT: 9000
      SPRING_PROFILES_ACTIVE: docker
      SPRING_DATASOURCE_URL: jdbc:postgresql://postgres:5432/medapp
      SPRING_DATASOURCE_USERNAME: postgres
      SPRING_DATASOURCE_PASSWORD: postgres
      SPRING_JPA_HIBERNATE_DDL_AUTO: update
      JWT_ISSUER: medapp-auth
      JWT_TTL_MINUTES: 60
    expose:
      - '9000'
    depends_on:
      postgres:
        condition: service_healthy
    networks: [mednet]

  patient-service:
    build:
      context: ./services/patient-service
      dockerfile: Dockerfile
    restart: unless-stopped
    environment:
      SERVER_PORT: 8081
      SPRING_PROFILES_ACTIVE: docker
      SPRING_DATASOURCE_URL: jdbc:postgresql://postgres:5432/medapp
      SPRING_DATASOURCE_USERNAME: postgres
      SPRING_DATASOURCE_PASSWORD: postgres
      SPRING_JPA_HIBERNATE_DDL_AUTO: update
      KAFKA_BOOTSTRAP_SERVERS: kafka:9092
    expose:
      - '8081'
    depends_on:
      postgres:
        condition: service_healthy
      kafka:
        condition: service_healthy
    networks: [mednet]

  doctor-service:
    build:
      context: ./services/doctor-service
      dockerfile: Dockerfile
    restart: unless-stopped
    environment:
      SERVER_PORT: 8082
      SPRING_PROFILES_ACTIVE: docker
      SPRING_DATASOURCE_URL: jdbc:postgresql://postgres:5432/medapp
      SPRING_DATASOURCE_USERNAME: postgres
      SPRING_DATASOURCE_PASSWORD: postgres
      SPRING_JPA_HIBERNATE_DDL_AUTO: update
      KAFKA_BOOTSTRAP_SERVERS: kafka:9092
    expose:
      - '8082'
    depends_on:
      postgres:
        condition: service_healthy
      kafka:
        condition: service_healthy
    networks: [mednet]

  appointment-service:
    build:
      context: ./services/appointment-service
      dockerfile: Dockerfile
    restart: unless-stopped
    environment:
      SERVER_PORT: 8083
      SPRING_PROFILES_ACTIVE: docker
      SPRING_DATASOURCE_URL: jdbc:postgresql://postgres:5432/medapp
      SPRING_DATASOURCE_USERNAME: postgres
      SPRING_DATASOURCE_PASSWORD: postgres
      SPRING_JPA_HIBERNATE_DDL_AUTO: update
      # messaging
      RABBITMQ_HOST: rabbitmq
      RABBITMQ_PORT: 5672
      KAFKA_BOOTSTRAP_SERVERS: kafka:9092
      # downstreams
      DOCTOR_SERVICE_URL: http://doctor-service:8082
      PATIENT_SERVICE_URL: http://patient-service:8081
    expose:
      - '8083'
    depends_on:
      postgres:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
      kafka:
        condition: service_healthy
    networks: [mednet]

  notification-service:
    build:
      context: ./services/notification-service
      dockerfile: Dockerfile
    restart: unless-stopped
    environment:
      SERVER_PORT: 8085
      SPRING_PROFILES_ACTIVE: docker
      # WS scaling + caching
      REDIS_HOST: redis
      REDIS_PORT: 6379
      # SMTP (to MailHog in dev)
      SMTP_HOST: mailhog
      SMTP_PORT: 1025
      # Optional: queue for async notifications
      RABBITMQ_HOST: rabbitmq
      RABBITMQ_PORT: 5672
    expose:
      - '8085'
    depends_on:
      redis:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
    networks: [mednet]

  admin-events-service:
    build:
      context: ./services/admin-events-service
      dockerfile: Dockerfile
    restart: unless-stopped
    environment:
      SERVER_PORT: 8086
      SPRING_PROFILES_ACTIVE: docker
      # This service owns event/notification topics & bindings
      KAFKA_BOOTSTRAP_SERVERS: kafka:9092
      RABBITMQ_HOST: rabbitmq
      RABBITMQ_PORT: 5672
      # Expose simple admin endpoints to create topics/queues/bindings
    expose:
      - '8086'
    depends_on:
      kafka:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
    networks: [mednet]

  analytics-service:
    build:
      context: ./services/analytics-service
      dockerfile: Dockerfile
    restart: unless-stopped
    environment:
      SERVER_PORT: 8087
      SPRING_PROFILES_ACTIVE: docker
      KAFKA_BOOTSTRAP_SERVERS: kafka:9092
      SPRING_DATASOURCE_URL: jdbc:postgresql://postgres:5432/medapp
      SPRING_DATASOURCE_USERNAME: postgres
      SPRING_DATASOURCE_PASSWORD: postgres
      SPRING_JPA_HIBERNATE_DDL_AUTO: update
    expose:
      - '8087'
    depends_on:
      kafka:
        condition: service_healthy
      postgres:
        condition: service_healthy
    networks: [mednet]

  # ====================== FRONTENDS (React -> Nginx static) ======================

  patient-ui:
    build:
      context: ./frontends/patient-ui
      dockerfile: Dockerfile
    restart: unless-stopped
    environment:
      # frontends call the gateway
      REACT_APP_API_BASE_URL: http://localhost:8080
      REACT_APP_WS_URL: ws://localhost:8080
    ports:
      - '3000:80' # container runs nginx serving the React build on :80
    networks: [mednet]
    depends_on:
      api-gateway:
        condition: service_started

  doctor-ui:
    build:
      context: ./frontends/doctor-ui
      dockerfile: Dockerfile
    restart: unless-stopped
    environment:
      REACT_APP_API_BASE_URL: http://localhost:8080
      REACT_APP_WS_URL: ws://localhost:8080
    ports:
      - '3001:80'
    networks: [mednet]
    depends_on:
      api-gateway:
        condition: service_started

  # --- Edge reverse proxy ---
  nginx:
    image: nginx:latest
    restart: unless-stopped
    volumes:
      - ./ops/nginx.conf:/etc/nginx/nginx.conf:ro
    depends_on:
      api-gateway:
        condition: service_started
    ports:
      - '4000:4000'
    networks: [mednet]
