version: '3.9'

networks:
  mednet:

volumes:
  postgres-data:
  kafka-data:
  redis-data:
  rabbitmq-data:

services:
  # --- Datastore ---
  postgres:
    image: postgres:16-alpine
    restart: always
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
      POSTGRES_DB: medapp
    ports:
      - '5432:5432'
    healthcheck:
      test: ['CMD-SHELL', 'pg_isready -U postgres -d medapp']
      interval: 10s
      timeout: 5s
      retries: 10
    volumes:
      - postgres-data:/var/lib/postgresql/data
    networks: [mednet]

  # --- Kafka ---
  zookeeper:
    image: confluentinc/cp-zookeeper:7.6.1
    environment:
      ZOOKEEPER_CLIENT_PORT: 2181
    ports:
      - '22181:2181'
    healthcheck:
      test: ['CMD-SHELL', 'zookeeper-shell localhost:2181 ls / >/dev/null 2>&1']
      interval: 10s
      timeout: 5s
      retries: 10
    networks: [mednet]

  kafka:
    image: confluentinc/cp-kafka:7.6.1
    depends_on:
      zookeeper:
        condition: service_healthy
    ports:
      - '9092:9092'
    environment:
      KAFKA_ZOOKEEPER_CONNECT: zookeeper:2181
      KAFKA_ZOOKEEPER_SESSION_TIMEOUT_MS: 30000
      KAFKA_ZOOKEEPER_CONNECTION_TIMEOUT_MS: 30000
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://kafka:9092,PLAINTEXT_HOST://localhost:29092
      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: PLAINTEXT:PLAINTEXT,PLAINTEXT_HOST:PLAINTEXT
      KAFKA_LISTENERS: PLAINTEXT://0.0.0.0:9092,PLAINTEXT_HOST://0.0.0.0:29092
      KAFKA_INTER_BROKER_LISTENER_NAME: PLAINTEXT
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1
      KAFKA_GROUP_INITIAL_REBALANCE_DELAY_MS: 0
      KAFKA_LOG4J_LOGGERS: 'kafka.controller=INFO,kafka.request.logger=WARN'
      KAFKA_LOG4J_ROOT_LOGLEVEL: WARN
    volumes:
      - kafka-data:/var/lib/kafka/data
    hostname: kafka
    restart: unless-stopped
    healthcheck:
      test: ['CMD-SHELL', 'nc -z localhost 9092 || exit 1']
      interval: 10s
      timeout: 5s
      retries: 5
    networks: [mednet]

  kafka-init:
    image: confluentinc/cp-kafka:7.6.1
    depends_on:
      kafka:
        condition: service_started
    entrypoint: ['/bin/bash', '-lc']
    command: >
      set -e;
      echo "Waiting for DNS 'kafka'..."; for i in {1..60}; do getent hosts kafka && break || sleep 2; done;
      echo "Waiting for broker kafka:9092..."; for i in {1..60}; do kafka-broker-api-versions --bootstrap-server kafka:9092 && break || sleep 2; done;
      echo "Creating topics...";
      kafka-topics --bootstrap-server kafka:9092 --create --if-not-exists --topic appointment-events  --partitions 1 --replication-factor 1;
      kafka-topics --bootstrap-server kafka:9092 --create --if-not-exists --topic notification-events --partitions 1 --replication-factor 1;
      kafka-topics --bootstrap-server kafka:9092 --create --if-not-exists --topic analytics-events    --partitions 1 --replication-factor 1;
      echo "Topics ready."
    networks: [mednet]

  # --- RabbitMQ ---
  rabbitmq:
    image: rabbitmq:3-management
    restart: unless-stopped
    environment:
      RABBITMQ_DEFAULT_USER: guest
      RABBITMQ_DEFAULT_PASS: guest
    ports:
      - '5672:5672'
      - '15672:15672'
    volumes:
      - rabbitmq-data:/var/lib/rabbitmq
    healthcheck:
      test: ['CMD', 'rabbitmq-diagnostics', '-q', 'ping']
      interval: 10s
      timeout: 5s
      retries: 10
    networks: [mednet]

  # --- Redis ---
  redis:
    image: redis:7-alpine
    restart: unless-stopped
    command: ['redis-server', '--save', '', '--appendonly', 'no']
    ports:
      - '6379:6379'
    healthcheck:
      test: ['CMD', 'redis-cli', 'ping']
      interval: 5s
      timeout: 3s
      retries: 20
    networks: [mednet]

  # --- LocalStack (FaaS) ---
  localstack:
    image: localstack/localstack:latest
    restart: unless-stopped
    environment:
      SERVICES: lambda,s3,sqs,sns,logs,sts,iam
      AWS_DEFAULT_REGION: eu-central-1
      DEBUG: '1'
    ports:
      - '4566:4566'
    networks: [mednet]

  # --- MailHog (dev SMTP) ---
  mailhog:
    image: mailhog/mailhog:latest
    restart: unless-stopped
    ports:
      - '1025:1025'
      - '8025:8025'
    networks: [mednet]

  # ====================== BACKEND SERVICES (Spring Boot) ======================

  auth-service:
    build:
      context: ./services/auth-service
      dockerfile: Dockerfile
    restart: unless-stopped
    environment:
      SERVER_PORT: 9000
      SPRING_PROFILES_ACTIVE: docker
      SPRING_DATASOURCE_URL: jdbc:postgresql://postgres:5432/medapp
      SPRING_DATASOURCE_USERNAME: postgres
      SPRING_DATASOURCE_PASSWORD: postgres
      SPRING_JPA_HIBERNATE_DDL_AUTO: update
      AUTH_ISSUER: medapp-auth
      AUTH_TTL_MINUTES: 60
    expose:
      - '9000'
    depends_on:
      postgres:
        condition: service_healthy
    networks: [mednet]

  patient-service:
    build:
      context: ./services/patient-service
      dockerfile: Dockerfile
    restart: unless-stopped
    environment:
      SERVER_PORT: 8081
      SPRING_PROFILES_ACTIVE: docker
      SPRING_DATASOURCE_URL: jdbc:postgresql://postgres:5432/medapp
      SPRING_DATASOURCE_USERNAME: postgres
      SPRING_DATASOURCE_PASSWORD: postgres
      SPRING_JPA_HIBERNATE_DDL_AUTO: update
      KAFKA_BOOTSTRAP_SERVERS: kafka:9092
      SPRING_SECURITY_OAUTH2_RESOURCESERVER_JWT_JWK_SET_URI: http://auth-service:9000/.well-known/jwks.json
    expose: ['8081']
    depends_on:
      postgres:
        condition: service_healthy
      kafka:
        condition: service_healthy
      kafka-init:
        condition: service_started
    networks: [mednet]

  doctor-service:
    build:
      context: ./services/doctor-service
      dockerfile: Dockerfile
    restart: unless-stopped
    environment:
      SERVER_PORT: 8082
      SPRING_PROFILES_ACTIVE: docker
      SPRING_DATASOURCE_URL: jdbc:postgresql://postgres:5432/medapp
      SPRING_DATASOURCE_USERNAME: postgres
      SPRING_DATASOURCE_PASSWORD: postgres
      SPRING_JPA_HIBERNATE_DDL_AUTO: update
      KAFKA_BOOTSTRAP_SERVERS: kafka:9092
      SPRING_SECURITY_OAUTH2_RESOURCESERVER_JWT_JWK_SET_URI: http://auth-service:9000/.well-known/jwks.json
    expose: ['8082']
    depends_on:
      postgres:
        condition: service_healthy
      kafka:
        condition: service_healthy
      kafka-init:
        condition: service_started
    networks: [mednet]

  appointment-service:
    build:
      context: ./services/appointment-service
      dockerfile: Dockerfile
    restart: unless-stopped
    environment:
      SERVER_PORT: 8083
      SPRING_PROFILES_ACTIVE: docker
      SPRING_DATASOURCE_URL: jdbc:postgresql://postgres:5432/medapp
      SPRING_DATASOURCE_USERNAME: postgres
      SPRING_DATASOURCE_PASSWORD: postgres
      SPRING_JPA_HIBERNATE_DDL_AUTO: update
      RABBITMQ_HOST: rabbitmq
      RABBITMQ_PORT: 5672
      KAFKA_BOOTSTRAP_SERVERS: kafka:9092
      DOCTOR_SERVICE_URL: http://doctor-service:8082
      PATIENT_SERVICE_URL: http://patient-service:8081
      SPRING_SECURITY_OAUTH2_RESOURCESERVER_JWT_JWK_SET_URI: http://auth-service:9000/.well-known/jwks.json
    expose: ['8083']
    depends_on:
      postgres:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
      kafka:
        condition: service_healthy
      kafka-init:
        condition: service_started
    networks: [mednet]

  notification-service:
    build:
      context: ./services/notification-service
      dockerfile: Dockerfile
    restart: unless-stopped
    environment:
      SERVER_PORT: 8085
      SPRING_PROFILES_ACTIVE: docker
      REDIS_HOST: redis
      REDIS_PORT: 6379
      SMTP_HOST: mailhog
      SMTP_PORT: 1025
      RABBITMQ_HOST: rabbitmq
      RABBITMQ_PORT: 5672
      SPRING_SECURITY_OAUTH2_RESOURCESERVER_JWT_JWK_SET_URI: http://auth-service:9000/.well-known/jwks.json
    expose: ['8085']
    depends_on:
      redis:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
    networks: [mednet]

  admin-events-service:
    build:
      context: ./services/admin-events-service
      dockerfile: Dockerfile
    restart: unless-stopped
    environment:
      SERVER_PORT: 8086
      SPRING_PROFILES_ACTIVE: docker
      KAFKA_BOOTSTRAP_SERVERS: kafka:9092
      RABBITMQ_HOST: rabbitmq
      RABBITMQ_PORT: 5672
      SPRING_SECURITY_OAUTH2_RESOURCESERVER_JWT_JWK_SET_URI: http://auth-service:9000/.well-known/jwks.json
    expose: ['8086']
    depends_on:
      kafka:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
      kafka-init:
        condition: service_started
    networks: [mednet]

  analytics-service:
    build:
      context: ./services/analytics-service
      dockerfile: Dockerfile
    restart: unless-stopped
    environment:
      SERVER_PORT: 8087
      SPRING_PROFILES_ACTIVE: docker
      KAFKA_BOOTSTRAP_SERVERS: kafka:9092
      SPRING_DATASOURCE_URL: jdbc:postgresql://postgres:5432/medapp
      SPRING_DATASOURCE_USERNAME: postgres
      SPRING_DATASOURCE_PASSWORD: postgres
      SPRING_JPA_HIBERNATE_DDL_AUTO: update
      SPRING_SECURITY_OAUTH2_RESOURCESERVER_JWT_JWK_SET_URI: http://auth-service:9000/.well-known/jwks.json
    expose: ['8087']
    depends_on:
      kafka:
        condition: service_healthy
      postgres:
        condition: service_healthy
      kafka-init:
        condition: service_started
    networks: [mednet]

  # ====================== FRONTENDS (React -> Nginx static) ======================
  patient-ui:
    build:
      context: ./frontends/patient-ui
      dockerfile: Dockerfile
    restart: unless-stopped
    environment:
      REACT_APP_API_BASE_URL: http://localhost:4000
      REACT_APP_WS_URL: ws://localhost:4000
    ports:
      - '3000:80'
    networks: [mednet]

  doctor-ui:
    build:
      context: ./frontends/doctor-ui
      dockerfile: Dockerfile
    restart: unless-stopped
    environment:
      REACT_APP_API_BASE_URL: http://localhost:4000
      REACT_APP_WS_URL: ws://localhost:4000
    ports:
      - '3001:80'
    networks: [mednet]

  # --- Edge reverse proxy ---
  nginx:
    image: nginx:alpine
    restart: unless-stopped
    volumes:
      - ./ops/nginx/nginx.conf:/etc/nginx/nginx.conf:ro
    depends_on:
      - auth-service
      - patient-service
      - doctor-service
      # - appointment-service
      # - notification-service
      # - patient-ui
      # - doctor-ui
    ports:
      - '4000:4000'
    networks: [mednet]
